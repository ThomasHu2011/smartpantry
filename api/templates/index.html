{% extends "base.html" %}

{% block title %}Home - SmartPantry{% endblock %}

{% block extra_head %}
<style>
    @keyframes pulse {
        0%, 100% { opacity: 1; transform: scale(1); }
        50% { opacity: 0.7; transform: scale(1.1); }
    }
    
    .pantry-item-card {
        animation: fadeInUp 0.5s ease-out forwards;
        opacity: 0;
        position: relative;
        z-index: 10;
    }
    
    .pantry-item-wrapper {
        position: relative;
        z-index: 10;
    }
    
    #pantryItemsContainer {
        position: relative;
        z-index: 10;
    }
    
    /* Ensure pantry items appear above card header */
    .card-body {
        position: relative;
        z-index: 5;
    }
    
    .card-header {
        position: relative;
        z-index: 1;
    }
    
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .hero-section {
        animation: fadeIn 0.8s ease-out;
    }
    
    .card {
        animation: fadeIn 0.6s ease-out;
    }
    
    /* Fix modal backdrop - reduce blur and ensure proper cleanup */
    .modal-backdrop {
        background-color: rgba(0, 0, 0, 0.25) !important;
        backdrop-filter: blur(1px) !important;
        -webkit-backdrop-filter: blur(1px) !important;
        z-index: 1040 !important;
    }
    
    .modal-backdrop.show {
        opacity: 1 !important;
    }
    
    .modal {
        z-index: 1055 !important;
    }
    
    /* Ensure modal content is clickable */
    .modal-content {
        pointer-events: auto !important;
        z-index: 1056 !important;
        position: relative;
    }
    
    /* Ensure all modal elements are clickable */
    .modal.show .modal-content,
    .modal.show .modal-content * {
        pointer-events: auto !important;
    }
    
    /* Ensure modal dialog is above backdrop */
    .modal-dialog {
        z-index: 1055 !important;
        position: relative;
    }
    
    /* Prevent backdrop from staying after modal closes */
    body:not(.modal-open) .modal-backdrop {
        display: none !important;
        opacity: 0 !important;
        visibility: hidden !important;
        pointer-events: none !important;
    }
    
    /* Ensure backdrop doesn't block modal content clicks */
    .modal-backdrop {
        pointer-events: auto !important;
    }
    
    .modal.show ~ .modal-backdrop {
        pointer-events: auto !important;
    }
    
    /* Fix text overflow in pantry item names */
    .pantry-item-card .fw-bold {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        max-width: 100%;
        display: block;
    }
    
    /* Prevent card hover overflow */
    .pantry-item-wrapper {
        overflow: visible;
    }
    
    .pantry-item-card {
        overflow: hidden;
        will-change: transform;
    }
    
    /* Fix mobile responsiveness */
    @media (max-width: 768px) {
        .pantry-item-card {
            margin-bottom: 12px;
        }
        
        .card-body {
            padding: 16px !important;
        }
        
        .card-header {
            padding: 16px !important;
        }
        
        .hero-section {
            padding: 40px 0 !important;
        }
        
        .hero-section h1 {
            font-size: 2rem !important;
        }
        
        .btn-lg {
            padding: 12px 24px !important;
            font-size: 0.9rem !important;
        }
        
        .badge {
            font-size: 0.75rem !important;
            padding: 6px 12px !important;
        }
        
        .dropdown-menu {
            max-width: 100%;
            white-space: normal;
        }
        
        .dropdown-item {
            white-space: normal;
            word-wrap: break-word;
        }
    }
    
    /* Fix button text overflow */
    .btn {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    
    .btn-lg {
        white-space: normal;
    }
    
    /* Fix badge display on small screens */
    .badge {
        max-width: 100%;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
        display: inline-block;
    }
    
    /* Ensure cards don't overflow container */
    .card {
        max-width: 100%;
        overflow: hidden;
    }
    
    /* Fix flex-grow text overflow */
    .flex-grow-1 {
        min-width: 0;
        overflow: hidden;
    }
    
    /* Recipe card improvements */
    .recipe-card {
        overflow: hidden;
    }
    
    .recipe-card .card-title {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    
    /* Fix sort dropdown on mobile */
    @media (max-width: 576px) {
        .dropdown-toggle {
            font-size: 0.875rem;
            padding: 6px 12px;
        }
        
        .card-header .d-flex {
            flex-direction: column;
            align-items: flex-start !important;
            gap: 12px;
        }
        
        .card-header .d-flex > div:last-child {
            width: 100%;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="hero-section text-white py-5 mb-4">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-lg-8">
                <div class="d-flex align-items-center mb-4">
                    <img src="{{ url_for('static', filename='logo.png') }}" alt="Smart Pantry" height="80" class="me-3" style="max-width: 80px;">
                    <div>
                        <h1 class="display-4 fw-bold mb-1" style="text-shadow: 0 2px 8px rgba(0,0,0,0.2);">SmartPantry</h1>
                        <p class="mb-0 opacity-90" style="font-size: 1.1rem;">Your intelligent kitchen companion</p>
                    </div>
                </div>
                {% if username %}
                    <p class="lead mb-3 opacity-95" style="font-size: 1.2rem;">Welcome back, <strong>{{ username }}</strong>!</p>
                {% endif %}
                <div class="d-flex flex-wrap gap-3 mt-4">
                    <span class="badge px-4 py-2 border-0" style="background: rgba(255,255,255,0.25); backdrop-filter: blur(10px); color: white; border-radius: 12px;">
                        <i class="bi bi-camera-fill me-2"></i>Photo Recognition
                    </span>
                    <span class="badge px-4 py-2 border-0" style="background: rgba(255,255,255,0.25); backdrop-filter: blur(10px); color: white; border-radius: 12px;">
                        <i class="bi bi-book me-2"></i>Smart Recipes
                    </span>
                    <span class="badge px-4 py-2 border-0" style="background: rgba(255,255,255,0.25); backdrop-filter: blur(10px); color: white; border-radius: 12px;">
                        <i class="bi bi-graph-up me-2"></i>Nutrition Tracking
                    </span>
                </div>
            </div>
            <div class="col-lg-4 text-center mt-4 mt-lg-0">
                <div style="width: 140px; height: 140px; background: linear-gradient(135deg, rgba(255,255,255,0.2) 0%, rgba(255,255,255,0.1) 100%); border-radius: 35px; display: flex; align-items: center; justify-content: center; margin: 0 auto; box-shadow: 0 12px 32px rgba(0,0,0,0.2); backdrop-filter: blur(10px);">
                    <i class="bi bi-house-heart" style="font-size: 4rem; opacity: 0.9;"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container py-4">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <!-- Quick Actions Card - Cleaner Design -->
            <div class="card shadow-sm border-0 mb-4" style="border-radius: 20px; overflow: hidden;">
                <div class="card-body p-4">
                    <div class="row g-4">
                        <!-- Manual Add Item -->
                        <div class="col-md-6">
                            <div class="h-100 p-4" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.08) 0%, rgba(59, 130, 246, 0.05) 100%); border-radius: 18px; border: 1px solid rgba(139, 92, 246, 0.15);">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="me-3" style="width: 48px; height: 48px; background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                                        <i class="bi bi-plus-circle-fill text-white" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h5 class="mb-0 fw-bold" style="color: #1e293b;">Add Items</h5>
                                </div>
                                <form action="/add" method="post" id="addItemForm" onsubmit="return handleAddItem(event);">
                                    <div class="mb-3">
                                        <label class="form-label fw-semibold small text-muted mb-2">Item Name</label>
                                        <input type="text" name="item" id="itemInput" class="form-control form-control-lg" 
                                               placeholder="e.g., Milk, Bread, Eggs" required autocomplete="off"
                                               style="border-radius: 12px; border: 2px solid #e2e8f0; padding: 14px 16px;">
                                        <div class="row g-2 mt-2">
                                            <div class="col-6">
                                                <label class="form-label fw-semibold small text-muted mb-1">Quantity</label>
                                                <input type="text" name="quantity" id="quantityInput" class="form-control" 
                                                       placeholder="1" value="1" autocomplete="off"
                                                       style="border-radius: 10px; border: 2px solid #e2e8f0;">
                                            </div>
                                            <div class="col-6">
                                                <label class="form-label fw-semibold small text-muted mb-1">Expires <span class="text-muted" style="font-weight: normal;">(optional)</span></label>
                                                <input type="date" name="expiration_date" id="expirationInput" class="form-control"
                                                       style="border-radius: 10px; border: 2px solid #e2e8f0;"
                                                       value="">
                                            </div>
                                        </div>
                                    </div>
                                    <button type="submit" class="btn btn-primary btn-lg w-100" id="addItemBtn"
                                            style="border-radius: 12px; padding: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(139, 92, 246, 0.3);">
                                        <i class="bi bi-plus-circle-fill me-2"></i><span id="addItemBtnText">Add to Pantry</span>
                                    </button>
                                </form>
                                <div id="addItemFeedback" class="mt-3" style="display: none;"></div>
                            </div>
                        </div>
                        
                        <!-- Photo Upload -->
                        <div class="col-md-6">
                            <div class="h-100 p-4" style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.08) 0%, rgba(5, 150, 105, 0.05) 100%); border-radius: 18px; border: 1px solid rgba(16, 185, 129, 0.15);">
                                <div class="d-flex align-items-center mb-4">
                                    <div class="me-3" style="width: 48px; height: 48px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 14px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                        <i class="bi bi-camera-fill text-white" style="font-size: 1.5rem;"></i>
                                    </div>
                                    <h5 class="mb-0 fw-bold" style="color: #1e293b;">Photo Upload</h5>
                                </div>
                                <p class="text-muted small mb-3">Upload a photo and let AI detect food items automatically</p>
                                <button type="button" class="btn btn-success btn-lg w-100" data-bs-toggle="modal" data-bs-target="#photoModal"
                                        style="border-radius: 12px; padding: 14px; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);">
                                    <i class="bi bi-camera-fill me-2"></i>Take/Upload Photo
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pantry Overview - Cleaner Design -->
            <div class="card shadow-sm border-0" style="border-radius: 20px; overflow: visible; position: relative; z-index: 1;">
                <div class="card-header border-0" style="background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.08) 100%); padding: 20px 24px; position: relative; z-index: 1; overflow: visible;">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0 fw-bold" style="color: #1e293b; font-size: 1.25rem;">
                            <i class="bi bi-basket-fill me-2" style="color: #8B5CF6;"></i>Your Pantry
                        </h5>
                        <div class="d-flex align-items-center gap-2">
                            {% if items %}
                            <span class="badge px-3 py-2" style="background: linear-gradient(135deg, #8B5CF6 0%, #3B82F6 100%); color: white; border-radius: 10px; font-size: 0.875rem; font-weight: 600;">
                                <i class="bi bi-basket-fill me-1"></i>{{ items|length }} {{ 'item' if items|length == 1 else 'items' }}
                            </span>
                            {% endif %}
                            {% if items is defined and items is not none and items|length > 1 %}
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="sortDropdown" data-bs-toggle="dropdown" aria-expanded="false" style="border-radius: 8px;">
                                    <i class="bi bi-sort-down me-1"></i>Sort
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="sortDropdown">
                                    <li><a class="dropdown-item" href="#" onclick="sortPantry('category'); return false;"><i class="bi bi-grid-3x3-gap me-2"></i>Category</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="sortPantry('name'); return false;"><i class="bi bi-sort-alpha-down me-2"></i>Name (A-Z)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="sortPantry('name-desc'); return false;"><i class="bi bi-sort-alpha-up me-2"></i>Name (Z-A)</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="sortPantry('expiration'); return false;"><i class="bi bi-calendar-check me-2"></i>Expiration (Soonest)</a></li>
                                    <li><a class="dropdown-item" href="#" onclick="sortPantry('expiration-desc'); return false;"><i class="bi bi-calendar-x me-2"></i>Expiration (Latest)</a></li>
                                </ul>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="card-body p-4" style="position: relative; z-index: 5; overflow: visible;">
                    {% if items is defined and items is not none and items|length > 0 %}
                    <div class="row g-3" id="pantryItemsContainer" style="position: relative; z-index: 10;">
                        {% for item in items %}
                        {% set item_name = (item.get('name', '') if item|is_dict else (item if item else ''))|string|trim %}
                        {% set item_name = item_name if item_name else 'Unnamed Item' %}
                        {% set exp_date = (item.get('expirationDate', '') if item|is_dict else '')|string|trim %}
                        {% set quantity = (item.get('quantity', '1') if item|is_dict else '1')|string|trim %}
                        {% set quantity = quantity if quantity else '1' %}
                        {% set item_id = (item.get('id', '') if item|is_dict else '')|string|trim %}
                        <div class="col-md-6 col-lg-4 pantry-item-wrapper" 
                             data-item-name="{{ item_name|lower|default('unnamed') }}"
                             data-item-id="{{ item_id }}"
                             data-expiration-date="{{ exp_date[:10] if exp_date and exp_date|length >= 10 else '9999-12-31' }}"
                             style="position: relative; z-index: 10;">
                            <div class="pantry-item-card card border-0 bg-white h-100 animate-fade-in" 
                                 style="border-radius: 18px; transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #e2e8f0; cursor: pointer;"
                                 data-animation-delay="{{ loop.index0 * 0.05 }}"
                                 onmouseover="this.style.transform='translateY(-6px) scale(1.02)'; this.style.boxShadow='0 12px 28px rgba(139, 92, 246, 0.15)'; this.style.borderColor='#8B5CF6';"
                                 onmouseout="this.style.transform='translateY(0) scale(1)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.05)'; this.style.borderColor='#e2e8f0';">
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1" style="min-width: 0; overflow: hidden;">
                                            <div class="d-flex align-items-center mb-2">
                                                <div class="me-2" style="width: 12px; height: 12px; background: linear-gradient(135deg, #10B981 0%, #059669 100%); border-radius: 50%; flex-shrink: 0; box-shadow: 0 2px 6px rgba(16, 185, 129, 0.4); animation: pulse 2s ease-in-out infinite;"></div>
                                                <span class="fw-bold text-dark" style="font-size: 1.05rem; line-height: 1.4; letter-spacing: -0.01em; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; min-width: 0;" title="{{ item_name }}">
                                                    {{ item_name }}
                                                </span>
                                            </div>
                                            {% if item|is_dict %}
                                                {% if item_id and item_id.strip() %}
                                                <div class="mb-2">
                                                    <span class="badge editable-quantity" 
                                                          data-item-id="{{ item_id }}"
                                                          data-item-name="{{ item_name }}"
                                                          data-current-quantity="{{ quantity }}"
                                                          data-expiration-date="{{ exp_date }}"
                                                          data-added-date="{{ item.get('addedDate', '') if item.get('addedDate') else '' }}"
                                                          style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6; border-radius: 8px; font-size: 0.75rem; cursor: pointer; transition: all 0.2s ease;"
                                                          title="Click to edit quantity"
                                                          onmouseover="this.style.background='rgba(139, 92, 246, 0.2)'; this.style.transform='scale(1.05)';"
                                                          onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'; this.style.transform='scale(1)';">
                                                        <i class="bi bi-123 me-1"></i><span class="quantity-value">{{ quantity }}</span>
                                                    </span>
                                                </div>
                                                {% elif quantity and quantity != '1' %}
                                                <div class="mb-2">
                                                    <span class="badge" style="background: rgba(139, 92, 246, 0.1); color: #8B5CF6; border-radius: 8px; font-size: 0.75rem;">
                                                        <i class="bi bi-123 me-1"></i>{{ quantity }}
                                                    </span>
                                                </div>
                                                {% endif %}
                                                {% if exp_date and exp_date != 'None' and exp_date != '' %}
                                                    <div>
                                                        <span class="expiration-badge expiration-fresh" data-exp-date="{{ exp_date }}" style="font-size: 0.75rem;">
                                                            <i class="bi bi-calendar3 me-1"></i>
                                                            {% if exp_date|length >= 10 %}
                                                                {{ exp_date[:10] }}
                                                            {% else %}
                                                                {{ exp_date }}
                                                            {% endif %}
                                                        </span>
                                                    </div>
                                                {% endif %}
                                            {% endif %}
                                        </div>
                                        <button type="button"
                                           class="btn btn-sm btn-outline-danger delete-item-btn" 
                                           style="border-radius: 50%; width: 36px; height: 36px; padding: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0;"
                                           title="Remove item"
                                           data-item-name="{{ item_name|urlencode }}"
                                           onmouseover="this.style.background='#ef4444'; this.style.color='white'; this.style.transform='scale(1.1)';"
                                           onmouseout="this.style.background='transparent'; this.style.color='#ef4444'; this.style.transform='scale(1)';">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="empty-state text-center py-5">
                        <div class="mb-4">
                            <div style="width: 120px; height: 120px; margin: 0 auto; background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(59, 130, 246, 0.08) 100%); border-radius: 30px; display: flex; align-items: center; justify-content: center;">
                                <i class="bi bi-basket" style="font-size: 4rem; color: #8B5CF6; opacity: 0.6;"></i>
                            </div>
                        </div>
                        <h4 class="mt-4 mb-2 fw-bold" style="color: #1e293b;">Your pantry is empty</h4>
                        <p class="mb-4 text-muted" style="font-size: 1rem;">Start adding items to get personalized recipe suggestions!</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Recipe Suggestions Card -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-gradient-success text-white border-0">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-book me-2"></i>Smart Recipes
                    </h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        <div style="width: 80px; height: 80px; background: linear-gradient(135deg, rgba(16, 185, 129, 0.2) 0%, rgba(5, 150, 105, 0.2) 100%); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin: 0 auto;">
                            <i class="bi bi-book" style="font-size: 2.5rem; color: #10B981;"></i>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="expiringDays" class="form-label text-muted small fw-semibold mb-2 d-block">
                            <i class="bi bi-clock me-1"></i>Use items expiring within:
                        </label>
                        <select class="form-select form-select-lg" id="expiringDays" style="border-radius: 12px;">
                            <option value="">All items</option>
                            <option value="3">3 days</option>
                            <option value="7">7 days</option>
                            <option value="14">14 days</option>
                            <option value="30">30 days</option>
                        </select>
                    </div>
                    <a href="{{ url_for('suggest_recipe') }}" class="btn btn-success btn-lg w-100 mb-3" id="recipeBtn" style="border-radius: 16px;">
                        <i class="bi bi-stars me-2"></i>Get Recipe Ideas
                    </a>
                    <p class="text-muted small mb-0">
                        <i class="bi bi-stars me-1"></i>AI-powered recipe suggestions
                    </p>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-gradient-info text-white border-0">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-graph-up me-2"></i>Pantry Stats
                    </h5>
                </div>
                <div class="card-body">
                    <div class="stat-card">
                        <div class="stat-number mb-2">{{ items|length }}</div>
                        <div class="text-muted fw-semibold">Total Items</div>
                    </div>
                </div>
            </div>

            <!-- Quick Tips -->
            <div class="card shadow-sm border-0">
                <div class="card-header bg-gradient-warning text-dark border-0">
                    <h5 class="mb-0 fw-bold">
                        <i class="bi bi-info-circle-fill me-2"></i>Pro Tips
                    </h5>
                </div>
                <div class="card-body">
                    <div class="d-flex mb-3 pb-3" style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                        <div class="me-3" style="width: 32px; height: 32px; background: rgba(16, 185, 129, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-check-circle-fill text-success"></i>
                        </div>
                        <div>
                            <strong class="d-block mb-1">Smart Upload</strong>
                            <small class="text-muted">Use clear, well-lit photos for better AI recognition</small>
                        </div>
                    </div>
                    <div class="d-flex mb-3 pb-3" style="border-bottom: 1px solid rgba(0,0,0,0.05);">
                        <div class="me-3" style="width: 32px; height: 32px; background: rgba(139, 92, 246, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-stars text-primary"></i>
                        </div>
                        <div>
                            <strong class="d-block mb-1">Recipe Magic</strong>
                            <small class="text-muted">More items = better recipe suggestions</small>
                        </div>
                    </div>
                    <div class="d-flex">
                        <div class="me-3" style="width: 32px; height: 32px; background: rgba(59, 130, 246, 0.1); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                            <i class="bi bi-graph-up-arrow text-info"></i>
                        </div>
                        <div>
                            <strong class="d-block mb-1">Nutrition Tracking</strong>
                            <small class="text-muted">Get detailed nutrition info for your recipes</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Photo Upload Modal -->
<div class="modal fade" id="photoModal" tabindex="-1" aria-labelledby="photoModalLabel" aria-hidden="true" data-bs-backdrop="true" data-bs-keyboard="true" style="pointer-events: auto;">
    <div class="modal-dialog modal-lg modal-dialog-centered" style="pointer-events: auto; z-index: 1055;">
        <div class="modal-content" style="border-radius: 24px; border: none; pointer-events: auto; z-index: 1056; position: relative;">
            <div class="modal-header border-0 pb-0" style="pointer-events: auto;">
                <h5 class="modal-title fw-bold" id="photoModalLabel">
                    <i class="bi bi-camera-fill me-2 text-success"></i>Add Items with Photo
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" style="pointer-events: auto; cursor: pointer; z-index: 10;"></button>
            </div>
            <div class="modal-body p-4">
                <!-- Camera View (Hidden by default) -->
                <div id="cameraView" class="camera-preview mb-3" style="display: none;">
                    <video id="cameraStream" autoplay playsinline></video>
                    <div class="camera-controls">
                        <button type="button" class="btn btn-light btn-sm me-2" id="closeCameraBtn">
                            <i class="bi bi-x-lg"></i> Close
                        </button>
                        <button type="button" class="capture-btn" id="captureBtn" title="Capture Photo"></button>
                    </div>
                </div>

                <!-- Upload Zone -->
                <div id="uploadZone">
                    <!-- Camera Buttons -->
                    <div class="row g-2 mb-3">
                        <div class="col-6">
                            <button type="button" class="btn btn-outline-success w-100" id="openCameraBtn">
                                <i class="bi bi-camera-video me-2"></i>Live Camera
                            </button>
                        </div>
                        <div class="col-6">
                            <button type="button" class="btn btn-success w-100" id="mobileCameraBtn">
                                <i class="bi bi-camera-fill me-2"></i>Take Photo
                            </button>
                        </div>
                    </div>

                    <div class="text-center mb-3">
                        <span class="text-muted">or</span>
                    </div>

                    <!-- Drag & Drop Zone -->
                    <div class="photo-upload-zone" id="dropZone">
                        <i class="bi bi-cloud-upload display-1 text-muted mb-3"></i>
                        <h5 class="mb-2">Drag & Drop Photo Here</h5>
                        <p class="text-muted mb-3">or click to browse</p>
                        <button type="button" class="btn btn-primary" id="browseBtn">
                            <i class="bi bi-folder2-open me-2"></i>Browse Files
                        </button>
                        <input type="file" id="photoInput" accept="image/*" style="display: none;">
                        <input type="file" id="mobileCameraInput" accept="image/*" capture="environment" style="display: none;">
                    </div>
                </div>

                <!-- Preview & Upload Section (Hidden by default) -->
                <div id="previewSection" style="display: none;">
                    <div class="text-center">
                        <img id="imagePreview" class="image-preview" alt="Preview">
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-secondary me-2" id="cancelUploadBtn">
                                <i class="bi bi-x-circle me-2"></i>Cancel
                            </button>
                            <button type="button" class="btn btn-success btn-lg" id="uploadBtn">
                                <i class="bi bi-stars me-2"></i><span id="uploadBtnText">Analyze & Add Items</span>
                            </button>
                        </div>
                        <small class="text-muted d-block mt-2">AI will detect food items in your photo</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let selectedFile = null;
    let cameraStream = null;

    // DOM Elements
    const photoModal = document.getElementById('photoModal');
    const photoInput = document.getElementById('photoInput');
    const mobileCameraInput = document.getElementById('mobileCameraInput');
    const dropZone = document.getElementById('dropZone');
    const browseBtn = document.getElementById('browseBtn');
    const mobileCameraBtn = document.getElementById('mobileCameraBtn');
    const uploadZone = document.getElementById('uploadZone');
    const previewSection = document.getElementById('previewSection');
    const imagePreview = document.getElementById('imagePreview');
    const uploadBtn = document.getElementById('uploadBtn');
    const cancelUploadBtn = document.getElementById('cancelUploadBtn');
    const uploadBtnText = document.getElementById('uploadBtnText');
    
    // Camera Elements
    const cameraView = document.getElementById('cameraView');
    const cameraStreamVideo = document.getElementById('cameraStream');
    const openCameraBtn = document.getElementById('openCameraBtn');
    const closeCameraBtn = document.getElementById('closeCameraBtn');
    const captureBtn = document.getElementById('captureBtn');

    // Browse button click
    if (browseBtn && photoInput) {
        browseBtn.addEventListener('click', () => photoInput.click());
    }

    // Mobile camera button (works without HTTPS)
    if (mobileCameraBtn && mobileCameraInput) {
        mobileCameraBtn.addEventListener('click', () => mobileCameraInput.click());
    }

    // File input change
    if (photoInput) {
        photoInput.addEventListener('change', handleFileSelect);
    }
    if (mobileCameraInput) {
        mobileCameraInput.addEventListener('change', handleFileSelect);
    }

    // Drag and drop handlers
    if (dropZone) {
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('dragover');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        dropZone.addEventListener('click', (e) => {
            if (e.target === dropZone || e.target.closest('#dropZone')) {
                if (photoInput) {
                    photoInput.click();
                }
            }
        });
    }

    // Handle file selection
    function handleFileSelect(e) {
        const files = e.target.files;
        if (files.length > 0) {
            handleFile(files[0]);
        }
    }

    // Handle file
    function handleFile(file) {
        if (!file.type.startsWith('image/')) {
            alert('Please select an image file');
            return;
        }

        selectedFile = file;
        const reader = new FileReader();
        reader.onload = (e) => {
            if (imagePreview) imagePreview.src = e.target.result;
            if (uploadZone) uploadZone.style.display = 'none';
            if (previewSection) previewSection.style.display = 'block';
        };
        reader.readAsDataURL(file);
    }

    // Camera Functions
    if (openCameraBtn) {
        openCameraBtn.addEventListener('click', async () => {
        // Check if getUserMedia is supported
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            alert('Camera access requires HTTPS or localhost.\n\nTo use camera:\n1. Access via https:// (requires SSL certificate)\n2. Access via http://localhost:5050 or http://127.0.0.1:5050\n\nFor now, please use "Browse Files" to upload a photo instead.');
            return;
        }

        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: 'environment' } 
            });
            if (cameraStreamVideo) cameraStreamVideo.srcObject = cameraStream;
            if (uploadZone) uploadZone.style.display = 'none';
            if (cameraView) cameraView.style.display = 'block';
        } catch (err) {
            if (err.name === 'NotAllowedError') {
                alert('Camera permission denied. Please allow camera access and try again.');
            } else if (err.name === 'NotFoundError') {
                alert('No camera found on this device.');
            } else {
                alert('Could not access camera: ' + err.message + '\n\nPlease use "Browse Files" to upload a photo instead.');
            }
        }
        });
    }

    if (closeCameraBtn) {
        closeCameraBtn.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            stopCamera();
            if (cameraView) cameraView.style.display = 'none';
            if (uploadZone) uploadZone.style.display = 'block';
        });
        // Ensure button is clickable
        closeCameraBtn.style.pointerEvents = 'auto';
        closeCameraBtn.style.cursor = 'pointer';
        closeCameraBtn.style.zIndex = '10';
    }

    if (captureBtn && cameraStreamVideo) {
        captureBtn.addEventListener('click', () => {
        const canvas = document.createElement('canvas');
        canvas.width = cameraStreamVideo.videoWidth;
        canvas.height = cameraStreamVideo.videoHeight;
        canvas.getContext('2d').drawImage(cameraStreamVideo, 0, 0);
        
        canvas.toBlob((blob) => {
            selectedFile = new File([blob], 'camera-capture.jpg', { type: 'image/jpeg' });
            if (imagePreview) imagePreview.src = canvas.toDataURL('image/jpeg');
            stopCamera();
            if (cameraView) cameraView.style.display = 'none';
            if (previewSection) previewSection.style.display = 'block';
        }, 'image/jpeg');
        });
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraStream = null;
        }
    }

    // Cancel upload
    if (cancelUploadBtn) {
        cancelUploadBtn.addEventListener('click', () => {
            selectedFile = null;
            if (photoInput) photoInput.value = '';
            if (mobileCameraInput) mobileCameraInput.value = '';
            if (previewSection) previewSection.style.display = 'none';
            if (uploadZone) uploadZone.style.display = 'block';
            if (cameraView) cameraView.style.display = 'none';
            stopCamera();
            resetPhotoUploadButton();
        });
    }

    // Upload photo - Redone with better error handling and state management
    if (uploadBtn && uploadBtnText) {
        uploadBtn.addEventListener('click', async function handlePhotoUpload() {
            // Prevent multiple clicks
            if (uploadBtn.disabled) {
                return;
            }
            
            if (!selectedFile) {
                const feedback = document.getElementById('addItemFeedback');
                if (feedback) {
                    showFeedback('Please select a photo first', 'warning');
                } else {
                    alert('Please select a photo first');
                }
                return;
            }

            const formData = new FormData();
            formData.append('photo', selectedFile);

            // Set loading state
            uploadBtn.disabled = true;
            const originalText = uploadBtnText.textContent;
            uploadBtnText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Analyzing...';

            try {
                const response = await fetch('{{ url_for("upload_photo") }}', {
                    method: 'POST',
                    body: formData,
                    credentials: 'same-origin'
                });

                if (response.ok) {
                    // Show success message first
                    const feedback = document.getElementById('addItemFeedback');
                    if (feedback) {
                        showFeedback('Photo analyzed! Items added to pantry.', 'success');
                    }
                    
                    // Close modal
                    closePhotoModal();
                    
                    // Reset upload state
                    resetPhotoUploadState();
                    
                    // Update pantry items after a short delay
                    setTimeout(async () => {
                        await reloadPantryItems();
                    }, 300);
                } else {
                    // Handle error response
                    let errorMessage = 'Upload failed. Please try again.';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.error || errorMessage;
                    } catch (e) {
                        const errorText = await response.text();
                        if (errorText) {
                            errorMessage = errorText.substring(0, 100);
                        }
                    }
                    
                    const feedback = document.getElementById('addItemFeedback');
                    if (feedback) {
                        showFeedback(errorMessage, 'danger');
                    } else {
                        alert(errorMessage);
                    }
                    
                    // Reset button state
                    resetPhotoUploadButton();
                }
            } catch (err) {
                console.error('Photo upload error:', err);
                const errorMessage = err.message || 'Network error. Please check your connection and try again.';
                
                const feedback = document.getElementById('addItemFeedback');
                if (feedback) {
                    showFeedback(errorMessage, 'danger');
                } else {
                    alert('Upload error: ' + errorMessage);
                }
                
                // Reset button state
                resetPhotoUploadButton();
            }
        });
    }
    
    // Helper function to close photo modal
    function closePhotoModal() {
        if (!photoModal) return;
        
        // Try Bootstrap modal API first
        try {
            if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
                const bootstrapModal = bootstrap.Modal.getInstance(photoModal);
                if (bootstrapModal) {
                    bootstrapModal.hide();
                    return;
                }
            }
        } catch (e) {
            console.log('Bootstrap modal API not available:', e);
        }
        
        // Fallback: Use close button
        const closeBtn = photoModal.querySelector('[data-bs-dismiss="modal"]');
        if (closeBtn) {
            closeBtn.click();
        } else {
            // Last resort: Manual close
            photoModal.classList.remove('show');
            photoModal.style.display = 'none';
            photoModal.setAttribute('aria-hidden', 'true');
            
            // Remove backdrop
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    }
    
    // Helper function to reset photo upload state
    function resetPhotoUploadState() {
        selectedFile = null;
        if (photoInput) photoInput.value = '';
        if (mobileCameraInput) mobileCameraInput.value = '';
        if (cameraView) cameraView.style.display = 'none';
        if (previewSection) previewSection.style.display = 'none';
        if (uploadZone) uploadZone.style.display = 'block';
        stopCamera();
        resetPhotoUploadButton();
    }
    
    // Helper function to reset upload button
    function resetPhotoUploadButton() {
        if (uploadBtn) {
            uploadBtn.disabled = false;
        }
        if (uploadBtnText) {
            uploadBtnText.textContent = 'Analyze & Add Items';
        }
    }

    // Reset modal when closed
    if (photoModal) {
        // Handle modal shown
        photoModal.addEventListener('show.bs.modal', () => {
            // Ensure modal content and all children are clickable
            const modalContent = photoModal.querySelector('.modal-content');
            const modalDialog = photoModal.querySelector('.modal-dialog');
            if (modalContent) {
                modalContent.style.pointerEvents = 'auto';
                modalContent.style.zIndex = '1056';
                modalContent.style.position = 'relative';
                // Ensure all interactive elements are clickable
                const allElements = modalContent.querySelectorAll('*');
                allElements.forEach(el => {
                    el.style.pointerEvents = 'auto';
                    if (el.tagName === 'BUTTON' || el.tagName === 'INPUT' || el.tagName === 'A' || el.getAttribute('role') === 'button') {
                        el.style.cursor = 'pointer';
                    }
                });
            }
            if (modalDialog) {
                modalDialog.style.pointerEvents = 'auto';
                modalDialog.style.zIndex = '1055';
                modalDialog.style.position = 'relative';
            }
            // Ensure body can scroll
            document.body.style.overflow = 'hidden';
            
            // Force enable pointer events on modal
            photoModal.style.pointerEvents = 'auto';
            photoModal.style.zIndex = '1055';
        });
        
        // Also handle when modal is fully shown
        photoModal.addEventListener('shown.bs.modal', () => {
            // Double-check all elements are clickable
            const modalContent = photoModal.querySelector('.modal-content');
            const modalDialog = photoModal.querySelector('.modal-dialog');
            if (modalContent) {
                modalContent.style.pointerEvents = 'auto';
                modalContent.style.zIndex = '1056';
                const allButtons = modalContent.querySelectorAll('button, input, a, [role="button"], .btn, .btn-close');
                allButtons.forEach(btn => {
                    btn.style.pointerEvents = 'auto';
                    btn.style.cursor = 'pointer';
                    btn.style.zIndex = '10';
                });
            }
            if (modalDialog) {
                modalDialog.style.pointerEvents = 'auto';
                modalDialog.style.zIndex = '1055';
            }
            
            // Ensure close button works
            const closeBtn = photoModal.querySelector('[data-bs-dismiss="modal"]');
            if (closeBtn) {
                closeBtn.style.pointerEvents = 'auto';
                closeBtn.style.cursor = 'pointer';
                closeBtn.style.zIndex = '10';
                // Add click handler as backup
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const bootstrapModal = bootstrap.Modal.getInstance(photoModal);
                    if (bootstrapModal) {
                        bootstrapModal.hide();
                    } else {
                        photoModal.classList.remove('show');
                        photoModal.style.display = 'none';
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach(b => b.remove());
                        document.body.classList.remove('modal-open');
                        document.body.style.overflow = '';
                    }
                });
            }
        });
        
        // Add escape key handler
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && photoModal.classList.contains('show')) {
                const bootstrapModal = bootstrap.Modal.getInstance(photoModal);
                if (bootstrapModal) {
                    bootstrapModal.hide();
                } else {
                    const closeBtn = photoModal.querySelector('[data-bs-dismiss="modal"]');
                    if (closeBtn) {
                        closeBtn.click();
                    }
                }
            }
        });
        
        // Handle modal hiding (before close animation)
        photoModal.addEventListener('hide.bs.modal', () => {
            // Start cleanup early
            stopCamera();
        });
        
        // Handle modal fully closed (after animation)
        photoModal.addEventListener('hidden.bs.modal', () => {
            resetPhotoUploadState();
            
            // Comprehensive cleanup - remove all backdrops and restore body
            const cleanup = () => {
                // Remove all modal backdrops
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach(backdrop => {
                    backdrop.style.display = 'none';
                    backdrop.style.opacity = '0';
                    backdrop.style.visibility = 'hidden';
                    backdrop.style.pointerEvents = 'none';
                    backdrop.remove();
                });
                
                // Remove modal-open class from body
                document.body.classList.remove('modal-open');
                
                // Restore body styles completely
                document.body.style.overflow = '';
                document.body.style.paddingRight = '';
                document.body.style.pointerEvents = '';
                document.body.style.position = '';
                document.body.style.overflowX = '';
                document.body.style.overflowY = '';
                
                // Ensure modal is properly hidden
                if (photoModal) {
                    photoModal.classList.remove('show');
                    photoModal.style.display = 'none';
                    photoModal.setAttribute('aria-hidden', 'true');
                    photoModal.removeAttribute('aria-modal');
                }
                
                // Force remove any remaining backdrop elements
                const remainingBackdrops = document.querySelectorAll('.modal-backdrop');
                remainingBackdrops.forEach(backdrop => {
                    backdrop.style.display = 'none';
                    backdrop.style.pointerEvents = 'none';
                    backdrop.remove();
                });
                
                // Ensure no backdrop classes remain
                document.body.classList.remove('modal-open');
                
                // Force enable pointer events on body
                document.body.style.pointerEvents = 'auto';
                
                // Add style to prevent backdrop from showing
                if (!document.querySelector('style[data-modal-cleanup]')) {
                    const style = document.createElement('style');
                    style.setAttribute('data-modal-cleanup', 'true');
                    style.textContent = `
                        body:not(.modal-open) .modal-backdrop { 
                            display: none !important; 
                            opacity: 0 !important; 
                            visibility: hidden !important; 
                            pointer-events: none !important; 
                        }
                        body:not(.modal-open) {
                            pointer-events: auto !important;
                            overflow: auto !important;
                        }
                    `;
                    document.head.appendChild(style);
                }
            };
            
            // Cleanup immediately and also after delays to catch any delayed Bootstrap cleanup
            cleanup();
            setTimeout(cleanup, 50);
            setTimeout(cleanup, 100);
            setTimeout(cleanup, 200);
            setTimeout(cleanup, 500);
            setTimeout(cleanup, 1000);
        });
    }

    // Check camera availability on page load
    window.addEventListener('DOMContentLoaded', () => {
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
            // Disable live camera button (getUserMedia not available)
            openCameraBtn.disabled = true;
            openCameraBtn.innerHTML = '<i class="bi bi-camera-video-off me-2"></i>HTTPS Only';
            openCameraBtn.title = 'Live camera requires HTTPS or localhost. Use "Take Photo" button instead.';
            openCameraBtn.classList.add('opacity-50');
            
            // Make "Take Photo" button more prominent
            mobileCameraBtn.classList.remove('btn-success');
            mobileCameraBtn.classList.add('btn-success', 'pulse');
        }

        // Handle expiration days selector for recipe suggestions
        const recipeBtn = document.getElementById('recipeBtn');
        const expiringDaysSelect = document.getElementById('expiringDays');
        
        if (recipeBtn && expiringDaysSelect) {
            recipeBtn.addEventListener('click', (e) => {
                const expiringDays = expiringDaysSelect.value;
                if (expiringDays && expiringDays.trim() !== '') {
                    // If expiring days is selected, add it to the URL
                    e.preventDefault();
                    const baseUrl = recipeBtn.getAttribute('href') || '{{ url_for("suggest_recipe") }}';
                    window.location.href = `${baseUrl}?expiring_days=${expiringDays}`;
                }
                // If no expiring days selected, let the link work normally (don't prevent default)
            });
        }
    });
    
    // Function to update expiration badge colors - can be called multiple times
    function updateExpirationBadges() {
        const badges = document.querySelectorAll('[data-exp-date]');
        if (!badges || badges.length === 0) {
            return;  // No badges to update
        }
        
        badges.forEach(function(badge) {
            try {
                if (!badge || !badge.getAttribute) {
                    return;  // Invalid badge element
                }
                
                const expDateStr = badge.getAttribute('data-exp-date');
                if (!expDateStr || expDateStr.trim() === '' || expDateStr === '9999-12-31' || expDateStr === 'None' || expDateStr === 'null') {
                    badge.classList.remove('expiration-expired', 'expiration-soon', 'expiration-fresh');
                    badge.classList.add('expiration-none');
                    return;
                }
                
                // Parse date string - handle both YYYY-MM-DD and ISO datetime formats
                let expiration;
                const dateStr = expDateStr.trim();
                
                // Check if it's a simple date format (YYYY-MM-DD)
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    // Parse YYYY-MM-DD format (most reliable)
                    const parts = dateStr.split('-').map(Number);
                    if (parts.length === 3 && parts[0] > 1900 && parts[0] < 2100 && parts[1] >= 1 && parts[1] <= 12 && parts[2] >= 1 && parts[2] <= 31) {
                        expiration = new Date(parts[0], parts[1] - 1, parts[2]);
                    } else {
                        throw new Error('Invalid date parts');
                    }
                } else if (dateStr.includes('T')) {
                    // ISO datetime format
                    expiration = new Date(dateStr);
                } else {
                    // Try parsing as date string
                    expiration = new Date(dateStr);
                }
                
                // Check if date is valid
                if (!expiration || isNaN(expiration.getTime())) {
                    console.warn('Invalid expiration date format:', dateStr);
                    badge.classList.remove('expiration-expired', 'expiration-soon', 'expiration-fresh');
                    badge.classList.add('expiration-none');
                    return;
                }
                
                // Calculate days difference
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                expiration.setHours(0, 0, 0, 0);
                const daysDiff = Math.floor((expiration - today) / (1000 * 60 * 60 * 24));
                
                // Remove all expiration classes first
                badge.classList.remove('expiration-expired', 'expiration-soon', 'expiration-fresh', 'expiration-none');
                
                // Apply appropriate class based on days until expiration
                if (daysDiff < 0) {
                    // Expired (past date)
                    badge.classList.add('expiration-expired');
                } else if (daysDiff < 3) {
                    // Expiring very soon (0-2 days) - red/orange
                    badge.classList.add('expiration-soon');
                } else if (daysDiff < 7) {
                    // Expiring soon (3-6 days) - orange/yellow
                    badge.classList.add('expiration-soon');
                } else {
                    // Fresh (7+ days) - green
                    badge.classList.add('expiration-fresh');
                }
            } catch (e) {
                // If there's any error parsing the date, use default styling
                console.error('Error parsing expiration date:', badge?.getAttribute('data-exp-date'), e);
                if (badge && badge.classList) {
                    badge.classList.remove('expiration-expired', 'expiration-soon', 'expiration-fresh');
                    badge.classList.add('expiration-none');
                }
            }
        });
    }
    
    // Set default expiration date to one week from now
    function setDefaultExpirationDate() {
        const expirationInput = document.getElementById('expirationInput');
        if (expirationInput && !expirationInput.value) {
            const today = new Date();
            const oneWeekLater = new Date(today);
            oneWeekLater.setDate(today.getDate() + 7);
            const year = oneWeekLater.getFullYear();
            const month = String(oneWeekLater.getMonth() + 1).padStart(2, '0');
            const day = String(oneWeekLater.getDate()).padStart(2, '0');
            expirationInput.value = `${year}-${month}-${day}`;
        }
    }
    
    // Sort pantry items
    // Category detection function
    function getItemCategory(itemName) {
        const name = itemName.toLowerCase();
        
        // Proteins
        const proteins = ['chicken', 'beef', 'pork', 'fish', 'salmon', 'tuna', 'turkey', 'egg', 'eggs', 'tofu', 'meat', 'protein', 'steak', 'bacon', 'sausage', 'ham', 'shrimp', 'prawn', 'crab', 'lobster', 'lamb', 'duck'];
        if (proteins.some(p => name.includes(p))) return 'proteins';
        
        // Vegetables
        const vegetables = ['broccoli', 'carrot', 'tomato', 'onion', 'garlic', 'lettuce', 'spinach', 'cucumber', 'pepper', 'potato', 'celery', 'corn', 'peas', 'bean', 'vegetable', 'cabbage', 'cauliflower', 'zucchini', 'eggplant', 'asparagus', 'mushroom', 'kale'];
        if (vegetables.some(v => name.includes(v))) return 'vegetables';
        
        // Dairy
        const dairy = ['milk', 'cheese', 'yogurt', 'butter', 'cream', 'dairy', 'sour cream', 'cottage cheese', 'mozzarella', 'cheddar', 'parmesan', 'feta'];
        if (dairy.some(d => name.includes(d))) return 'dairy';
        
        // Fruits
        const fruits = ['apple', 'banana', 'orange', 'berry', 'strawberry', 'blueberry', 'grape', 'mango', 'pineapple', 'peach', 'pear', 'cherry', 'kiwi', 'lemon', 'lime', 'fruit', 'avocado'];
        if (fruits.some(f => name.includes(f))) return 'fruits';
        
        // Snacks
        const snacks = ['chip', 'cracker', 'cookie', 'biscuit', 'pretzel', 'popcorn', 'nuts', 'almond', 'peanut', 'cashew', 'trail mix', 'granola', 'bar', 'candy', 'chocolate'];
        if (snacks.some(s => name.includes(s))) return 'snacks';
        
        // Grains
        const grains = ['bread', 'rice', 'pasta', 'noodle', 'flour', 'wheat', 'oats', 'quinoa', 'barley', 'cereal'];
        if (grains.some(g => name.includes(g))) return 'grains';
        
        // Beverages
        const beverages = ['juice', 'soda', 'water', 'coffee', 'tea', 'beer', 'wine', 'drink', 'beverage'];
        if (beverages.some(b => name.includes(b))) return 'beverages';
        
        // Default
        return 'other';
    }
    
    // Category order for sorting
    const categoryOrder = {
        'proteins': 1,
        'vegetables': 2,
        'fruits': 3,
        'dairy': 4,
        'grains': 5,
        'snacks': 6,
        'beverages': 7,
        'other': 8
    };
    
    // Store current sort type to re-apply after reload
    let currentSortType = null;
    
    function sortPantry(sortType) {
        const container = document.getElementById('pantryItemsContainer');
        if (!container) {
            console.warn('Pantry container not found');
            return;
        }
        
        const items = Array.from(container.querySelectorAll('.pantry-item-wrapper'));
        
        if (items.length === 0) {
            console.warn('No items to sort');
            return;
        }
        
        // Store sort type for re-application after reload
        currentSortType = sortType;
        sessionStorage.setItem('pantrySortType', sortType);
        
        items.sort((a, b) => {
            if (sortType === 'category') {
                const nameA = a.getAttribute('data-item-name') || '';
                const nameB = b.getAttribute('data-item-name') || '';
                const catA = getItemCategory(nameA);
                const catB = getItemCategory(nameB);
                
                // Sort by category first
                if (catA !== catB) {
                    return (categoryOrder[catA] || 99) - (categoryOrder[catB] || 99);
                }
                // Then by name within category
                return nameA.localeCompare(nameB);
            } else if (sortType === 'name') {
                const nameA = a.getAttribute('data-item-name') || '';
                const nameB = b.getAttribute('data-item-name') || '';
                return nameA.localeCompare(nameB);
            } else if (sortType === 'name-desc') {
                const nameA = a.getAttribute('data-item-name') || '';
                const nameB = b.getAttribute('data-item-name') || '';
                return nameB.localeCompare(nameA);
            } else if (sortType === 'expiration') {
                const dateA = a.getAttribute('data-expiration-date') || '9999-12-31';
                const dateB = b.getAttribute('data-expiration-date') || '9999-12-31';
                return dateA.localeCompare(dateB);
            } else if (sortType === 'expiration-desc') {
                const dateA = a.getAttribute('data-expiration-date') || '9999-12-31';
                const dateB = b.getAttribute('data-expiration-date') || '9999-12-31';
                return dateB.localeCompare(dateA);
            }
            return 0;
        });
        
        // Clear container and re-append sorted items
        container.innerHTML = '';
        items.forEach((item, index) => {
            // Update animation delay
            const card = item.querySelector('.pantry-item-card');
            if (card) {
                card.style.animationDelay = (index * 0.05) + 's';
            }
            container.appendChild(item);
        });
        
        // Ensure container is visible
        container.style.display = '';
        
        // Hide empty state if it exists
        const emptyState = container.closest('.card-body')?.querySelector('.empty-state');
        if (emptyState) {
            emptyState.style.display = 'none';
        }
        
        // Update expiration badges after sorting
        setTimeout(updateExpirationBadges, 100);
    }
    
    // Set animation delays from data attributes
    function setAnimationDelays() {
        document.querySelectorAll('[data-animation-delay]').forEach(function(element) {
            const delay = element.getAttribute('data-animation-delay');
            if (delay !== null) {
                element.style.animationDelay = delay + 's';
            }
        });
    }
    
    // Run expiration badge updates on page load
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setDefaultExpirationDate();
            setAnimationDelays();
            updateExpirationBadges();
            // Also run after a short delay to ensure all elements are rendered
            setTimeout(updateExpirationBadges, 200);
        });
    } else {
        // DOM already loaded
        setDefaultExpirationDate();
        setAnimationDelays();
        updateExpirationBadges();
        setTimeout(updateExpirationBadges, 200);
    }
    
    // Handle add item form submission
    function handleAddItem(event) {
        // Always prevent default form submission
        if (event) {
            event.preventDefault();
        }
        
        const form = document.getElementById('addItemForm');
        if (!form) {
            console.error('Form not found');
            return false;
        }
        
        const formData = new FormData(form);
        const itemName = formData.get('item');
        const expirationDateInput = document.getElementById('expirationInput');
        const btn = document.getElementById('addItemBtn');
        const btnText = document.getElementById('addItemBtnText');
        const feedback = document.getElementById('addItemFeedback');
        const itemInput = document.getElementById('itemInput');
        
        // Ensure expiration_date is included in FormData (even if empty)
        if (expirationDateInput) {
            const expirationDateValue = expirationDateInput.value || '';
            formData.set('expiration_date', expirationDateValue);
        }
        
        // Ensure quantity is included
        const quantityInput = document.getElementById('quantityInput');
        if (quantityInput) {
            const quantityValue = quantityInput.value || '1';
            formData.set('quantity', quantityValue);
        }
        
        // Validate input
        if (!itemName || !itemName.trim()) {
            if (feedback) {
                showFeedback('Please enter an item name', 'danger');
            }
            if (itemInput) {
                itemInput.focus();
            }
            return false;
        }
        
        // Disable button and show loading state
        if (btn) {
            btn.disabled = true;
        }
        if (btnText) {
            btnText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Adding...';
        }
        
        // Submit form using fetch
        fetch('/add', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin', // Include cookies for session
            headers: {
                'X-Requested-With': 'XMLHttpRequest' // Identify as AJAX request
            }
        })
        .then(async response => {
            // Check if response is JSON (success) or HTML (redirect/error)
            const contentType = response.headers.get('content-type');
            if (contentType && contentType.includes('application/json')) {
                // JSON response (AJAX mode)
                return response.json().then(async data => {
                    if (data.success) {
                        // Success - show feedback and reload
                        if (feedback) {
                            showFeedback(data.message || 'Item added successfully!', 'success');
                        }
                        // Clear form
                        if (form) {
                            form.reset();
                            if (quantityInput) quantityInput.value = '1';
                            if (expirationDateInput) expirationDateInput.value = '';
                        }
                        // Reset button state immediately
                        resetButton();
                        // Update pantry items without reloading page
                        // Add small delay to ensure server has finished saving
                        setTimeout(async () => {
                            await reloadPantryItems();
                        }, 300);
                    } else {
                        // Error from server
                        if (feedback) {
                            showFeedback(data.error || 'Failed to add item. Please try again.', 'danger');
                        }
                        resetButton();
                    }
                });
            } else {
                // HTML response (redirect) - Flask redirects return 302, then 200
                if (response.ok || response.status === 200 || response.status === 302) {
                    // Success - show feedback and reload
                    if (feedback) {
                        showFeedback('Item added successfully!', 'success');
                    }
                    // Clear form
                    if (form) {
                        form.reset();
                        if (quantityInput) quantityInput.value = '1';
                        if (expirationDateInput) expirationDateInput.value = '';
                    }
                    // Reset button state
                    resetButton();
                    // Update pantry items without reloading page
                    // Add small delay to ensure server has finished saving
                    setTimeout(async () => {
                        await reloadPantryItems();
                    }, 300);
                } else {
                    // Error response
                    return response.text().then(text => {
                        console.error('Server error:', text);
                        if (feedback) {
                            showFeedback('Failed to add item. Please try again.', 'danger');
                        }
                        resetButton();
                    });
                }
            }
        })
        .catch(error => {
            console.error('Error adding item:', error);
            if (feedback) {
                showFeedback('Failed to add item: ' + error.message, 'danger');
            }
            resetButton();
        });
        
        function resetButton() {
            if (btn) {
                btn.disabled = false;
            }
            if (btnText) {
                btnText.innerHTML = '<i class="bi bi-plus-circle-fill me-2"></i>Add to Pantry';
            }
        }
        
        return false; // Prevent default form submission
    }
    
    function showFeedback(message, type) {
        const feedback = document.getElementById('addItemFeedback');
        if (!feedback) return;
        
        feedback.className = `alert alert-${type} alert-dismissible fade show mt-3`;
        feedback.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        feedback.style.display = 'block';
        
        // Auto-hide after 5 seconds
        setTimeout(() => {
            if (feedback) {
                feedback.style.display = 'none';
            }
        }, 5000);
    }
    
    // Reload pantry items without refreshing the page
    async function reloadPantryItems() {
        // Store scroll position before reload
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        
        try {
            // Add cache busting to ensure we get fresh data
            const url = window.location.pathname + '?t=' + Date.now();
            const response = await fetch(url, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                cache: 'no-cache'  // Prevent browser caching
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const html = await response.text();
            if (!html || html.trim().length === 0) {
                throw new Error('Empty response from server');
            }
            
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            
            // Check for parsing errors
            const parserError = doc.querySelector('parsererror');
            if (parserError) {
                throw new Error('Failed to parse HTML response');
            }
            
            // Extract pantry items container and related elements
            // Find the pantry card by locating the container first, then finding its parent card
            const newContainer = doc.querySelector('#pantryItemsContainer');
            if (!newContainer) {
                console.error('Pantry items container not found in response, attempting full page reload');
                // Fallback: reload the entire page if container is missing from response
                window.location.reload();
                return;
            }
            
            // Find the parent card by traversing up the DOM tree
            let pantryCard = newContainer.closest('.card');
            if (!pantryCard) {
                // Fallback: try to find card containing "Your Pantry" text
                const allCards = doc.querySelectorAll('.card');
                pantryCard = Array.from(allCards).find(card => {
                    const header = card.querySelector('.card-header');
                    return header && header.textContent.includes('Your Pantry');
                }) || null;
            }
            
            const newCardBody = pantryCard ? pantryCard.querySelector('.card-body') : newContainer.parentElement;
            // Select the badge specifically from the pantry card header, not any badge on the page
            const pantryCardHeader = pantryCard ? pantryCard.querySelector('.card-header') : null;
            const newBadge = pantryCardHeader ? pantryCardHeader.querySelector('.badge') : null;
            const newEmptyState = (pantryCard || newCardBody) ? (pantryCard || newCardBody).querySelector('.empty-state') : doc.querySelector('.empty-state');
            const newSortDropdown = doc.querySelector('#sortDropdown')?.parentElement;
            
            // Find current elements - use the same reliable method
            const currentContainer = document.getElementById('pantryItemsContainer');
            if (!currentContainer) {
                console.warn('Current pantry items container not found, attempting full page reload');
                // Fallback: reload the entire page if container is missing
                window.location.reload();
                return;
            }
            
            // Find the current pantry card by traversing up from the container
            let currentPantryCard = currentContainer.closest('.card');
            if (!currentPantryCard) {
                // Fallback: try to find card containing "Your Pantry" text
                const allCards = document.querySelectorAll('.card');
                currentPantryCard = Array.from(allCards).find(card => {
                    const header = card.querySelector('.card-header');
                    return header && header.textContent.includes('Your Pantry');
                }) || null;
            }
            
            const currentCardBody = currentPantryCard ? currentPantryCard.querySelector('.card-body') : currentContainer.parentElement;
            const currentCardHeader = currentPantryCard ? currentPantryCard.querySelector('.card-header') : null;
            
            // Check if we have items or empty state
            // Always update if we have both containers
            if (newContainer && currentContainer) {
                // Update items container content
                currentContainer.innerHTML = newContainer.innerHTML;
                currentContainer.style.display = '';
                
                // Check if we have items or empty state
                if (newContainer.children.length > 0) {
                    // Items exist - hide empty state if it exists
                    const emptyState = currentCardBody?.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.style.display = 'none';
                    }
                    
                    // Update item count badge - select specifically from pantry card header
                    if (newBadge && currentCardHeader) {
                        const headerDiv = currentCardHeader.querySelector('.d-flex');
                        if (headerDiv) {
                            // Find existing badge in header
                            const currentBadge = headerDiv.querySelector('.badge');
                            if (currentBadge) {
                                currentBadge.outerHTML = newBadge.outerHTML;
                            } else {
                                // Insert badge if it doesn't exist
                                const dropdown = headerDiv.querySelector('.dropdown');
                                if (dropdown) {
                                    headerDiv.insertBefore(newBadge.cloneNode(true), dropdown);
                                } else {
                                    headerDiv.appendChild(newBadge.cloneNode(true));
                                }
                            }
                        }
                    }
                    
                    // Show sort dropdown if we have more than 1 item
                    const currentSortDropdown = currentCardHeader ? currentCardHeader.querySelector('.dropdown') : document.querySelector('.dropdown');
                    if (currentSortDropdown) {
                        currentSortDropdown.style.display = newContainer.children.length > 1 ? '' : 'none';
                    }
                    
                    // Re-initialize delete buttons
                    initializeDeleteButtons();
                    
                    // Re-initialize quantity editing
                    initializeQuantityEditing();
                    
                    // Re-initialize animations
                    initializeItemAnimations();
                    
                    // Re-apply sort if one was active
                    const savedSortType = sessionStorage.getItem('pantrySortType');
                    if (savedSortType && currentSortType === null) {
                        currentSortType = savedSortType;
                    }
                    if (currentSortType) {
                        setTimeout(() => {
                            sortPantry(currentSortType);
                        }, 100);
                    }
                    
                    // Update expiration badges
                    setTimeout(updateExpirationBadges, 100);
                } else {
                    // No items - ensure empty state is visible
                    // The empty state should already be in the container.innerHTML we just set
                    // But let's make sure it's displayed
                    const emptyState = currentCardBody?.querySelector('.empty-state');
                    if (emptyState) {
                        emptyState.style.display = '';
                    }
                    
                    // Hide sort dropdown
                    const sortDropdown = currentCardHeader ? currentCardHeader.querySelector('.dropdown') : document.querySelector('.dropdown');
                    if (sortDropdown) {
                        sortDropdown.style.display = 'none';
                    }
                    
                    // Hide badge
                    if (currentCardHeader) {
                        const headerDiv = currentCardHeader.querySelector('.d-flex');
                        if (headerDiv) {
                            const badge = headerDiv.querySelector('.badge');
                            if (badge) {
                                badge.style.display = 'none';
                            }
                        }
                    }
                    
                    // Clear sort type when empty
                    currentSortType = null;
                    sessionStorage.removeItem('pantrySortType');
                }
            } else if (newEmptyState && currentCardBody) {
                // If no items, show empty state
                currentCardBody.innerHTML = newCardBody.innerHTML;
                
                // Hide container if it exists
                if (currentContainer) {
                    currentContainer.style.display = 'none';
                }
                
                // Hide sort dropdown if it exists
                const sortDropdown = currentCardHeader ? currentCardHeader.querySelector('.dropdown') : document.querySelector('.dropdown');
                if (sortDropdown) {
                    sortDropdown.style.display = 'none';
                }
                
                // Hide badge if it exists - select specifically from pantry card header
                if (currentCardHeader) {
                    const headerDiv = currentCardHeader.querySelector('.d-flex');
                    if (headerDiv) {
                        const badge = headerDiv.querySelector('.badge');
                        if (badge) {
                            badge.style.display = 'none';
                        }
                    }
                }
                
                // Clear sort type when empty
                currentSortType = null;
                sessionStorage.removeItem('pantrySortType');
            } else if (currentContainer && newContainer) {
                // Fallback: just update the container
                currentContainer.innerHTML = newContainer.innerHTML;
                initializeDeleteButtons();
                initializeQuantityEditing();
                initializeItemAnimations();
                
                // Re-apply sort if one was active
                const savedSortType = sessionStorage.getItem('pantrySortType');
                if (savedSortType && currentSortType === null) {
                    currentSortType = savedSortType;
                }
                if (currentSortType) {
                    setTimeout(() => {
                        sortPantry(currentSortType);
                    }, 100);
                }
                
                setTimeout(updateExpirationBadges, 100);
            }
            
            // Restore scroll position
            window.scrollTo(0, scrollPosition);
            
        } catch (error) {
            console.error('Error reloading pantry items:', error);
            // Don't reload page - just show error message
            const feedback = document.getElementById('addItemFeedback');
            if (feedback) {
                showFeedback('Failed to reload items. Please refresh the page.', 'warning');
            }
        }
    }
    
    // Handle delete item via AJAX
    async function handleDeleteItem(itemName) {
        if (!itemName) {
            console.error('Item name is required for deletion');
            return;
        }
        
        // Store scroll position before deletion
        const scrollPosition = window.pageYOffset || document.documentElement.scrollTop;
        
        // Decode and sanitize item name
        const decodedName = decodeURIComponent(itemName);
        if (!confirm(`Remove "${decodedName}" from pantry?`)) {
            return;
        }
        
        try {
            // Properly encode the item name for URL
            const encodedName = encodeURIComponent(itemName);
            const response = await fetch(`/delete/${encodedName}`, {
                method: 'GET',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                },
                cache: 'no-cache'  // Prevent caching
            });
            
            if (response.ok) {
                // Add small delay to ensure server has finished processing
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Reload items (this will restore scroll position internally)
                await reloadPantryItems();
                
                // Restore scroll position after reload
                setTimeout(() => {
                    window.scrollTo(0, scrollPosition);
                }, 100);
                
                // Show success feedback
                const feedback = document.getElementById('addItemFeedback');
                if (feedback) {
                    showFeedback('Item removed successfully!', 'success');
                }
            } else {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                throw new Error(errorData.error || 'Failed to delete item');
            }
        } catch (error) {
            console.error('Error deleting item:', error);
            const feedback = document.getElementById('addItemFeedback');
            if (feedback) {
                showFeedback('Failed to delete item: ' + error.message, 'danger');
            } else {
                alert('Failed to delete item: ' + error.message);
            }
        }
    }
    
    // Initialize delete buttons
    function initializeDeleteButtons() {
        const deleteButtons = document.querySelectorAll('.delete-item-btn');
        deleteButtons.forEach(btn => {
            // Remove existing listeners
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            // Add new listener
            newBtn.addEventListener('click', function() {
                const itemName = this.getAttribute('data-item-name');
                handleDeleteItem(itemName);
            });
        });
    }
    
    // Handle quantity update via API
    async function handleUpdateQuantity(itemId, itemName, newQuantity, expirationDate, addedDate) {
        if (!itemId) {
            console.error('Item ID is required for update');
            showFeedback('Error: Item ID missing', 'danger');
            return;
        }
        
        try {
            // Prepare update data
            const updateData = {
                name: itemName,
                quantity: newQuantity || '1',
                expirationDate: expirationDate || null,
                addedDate: addedDate || new Date().toISOString()
            };
            
            // Get user ID and client type from headers (if available)
            const headers = {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest'
            };
            
            // Encode item ID for URL
            const encodedItemId = encodeURIComponent(itemId);
            
            const response = await fetch(`/api/pantry/${encodedItemId}`, {
                method: 'PUT',
                headers: headers,
                body: JSON.stringify(updateData),
                credentials: 'same-origin'
            });
            
            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Show success feedback
                    const feedback = document.getElementById('addItemFeedback');
                    if (feedback) {
                        showFeedback('Quantity updated successfully!', 'success');
                    }
                    
                    // Reload pantry items to reflect the change
                    await reloadPantryItems();
                } else {
                    throw new Error(data.error || 'Failed to update quantity');
                }
            } else {
                const errorData = await response.json().catch(() => ({ error: 'Unknown error' }));
                throw new Error(errorData.error || 'Failed to update quantity');
            }
        } catch (error) {
            console.error('Error updating quantity:', error);
            const feedback = document.getElementById('addItemFeedback');
            if (feedback) {
                showFeedback('Failed to update quantity: ' + error.message, 'danger');
            } else {
                alert('Failed to update quantity: ' + error.message);
            }
        }
    }
    
    // Initialize quantity editing
    function initializeQuantityEditing() {
        const quantityBadges = document.querySelectorAll('.editable-quantity');
        quantityBadges.forEach(badge => {
            // Remove existing listeners by cloning
            const newBadge = badge.cloneNode(true);
            badge.parentNode.replaceChild(newBadge, badge);
            
            // Add click listener
            newBadge.addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent card click
                
                const itemId = this.getAttribute('data-item-id');
                if (!itemId || itemId.trim() === '') {
                    console.warn('Cannot edit quantity: Item ID is missing');
                    showFeedback('Cannot edit: Item ID missing', 'warning');
                    return;
                }
                
                const itemName = this.getAttribute('data-item-name');
                const currentQuantity = this.getAttribute('data-current-quantity') || '1';
                const expirationDate = this.getAttribute('data-expiration-date') || null;
                const addedDate = this.getAttribute('data-added-date') || new Date().toISOString();
                
                // Create input field
                const quantityValue = this.querySelector('.quantity-value');
                if (!quantityValue) return;
                
                const oldText = quantityValue.textContent;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = currentQuantity;
                input.style.cssText = 'background: white; border: 2px solid #8B5CF6; border-radius: 6px; padding: 2px 6px; font-size: 0.75rem; width: 60px; text-align: center; color: #8B5CF6;';
                input.className = 'quantity-input';
                
                // Replace text with input
                quantityValue.textContent = '';
                quantityValue.appendChild(input);
                input.focus();
                input.select();
                
                // Handle save on blur or Enter
                const saveQuantity = async () => {
                    const newQuantity = input.value.trim() || '1';
                    if (newQuantity !== currentQuantity) {
                        // Update the badge attribute
                        newBadge.setAttribute('data-current-quantity', newQuantity);
                        // Call API to update
                        await handleUpdateQuantity(itemId, itemName, newQuantity, expirationDate, addedDate);
                    } else {
                        // Restore original text if no change
                        quantityValue.textContent = oldText;
                    }
                };
                
                const cancelEdit = () => {
                    quantityValue.textContent = oldText;
                };
                
                input.addEventListener('blur', saveQuantity);
                input.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        input.blur();
                    } else if (e.key === 'Escape') {
                        e.preventDefault();
                        cancelEdit();
                    }
                });
            });
        });
    }
    
    // Initialize item animations
    function initializeItemAnimations() {
        const items = document.querySelectorAll('.pantry-item-card');
        items.forEach((item, index) => {
            const delay = item.getAttribute('data-animation-delay') || (index * 0.05);
            item.style.animationDelay = `${delay}s`;
            item.style.opacity = '0';
            setTimeout(() => {
                item.style.opacity = '1';
            }, delay * 1000);
        });
    }
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        initializeDeleteButtons();
        initializeQuantityEditing();
        initializeItemAnimations();
        
        // Restore sort type if one was saved
        const savedSortType = sessionStorage.getItem('pantrySortType');
        if (savedSortType) {
            currentSortType = savedSortType;
            // Apply sort after a short delay to ensure DOM is ready
            setTimeout(() => {
                sortPantry(savedSortType);
            }, 300);
        }
    });
</script>
{% endblock %}

