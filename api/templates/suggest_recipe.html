{% extends "base.html" %}

{% block title %}AI Recipe Suggestions - SmartPantry{% endblock %}

{% block extra_head %}
<style>
    /* Orange-themed animated background for recipes page - Matching Swift App */
    body::before {
        content: '';
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: linear-gradient(135deg, 
            rgba(255, 159, 10, 0.30) 0%, 
            rgba(255, 159, 10, 0.25) 33%,
            rgba(236, 72, 153, 0.23) 66%,
            rgba(255, 193, 7, 0.20) 100%);
        background-size: 200% 200%;
        animation: gradientShiftOrange 15s ease-in-out infinite;
        z-index: -1;
        pointer-events: none;
    }
    
    @keyframes gradientShiftOrange {
        0% {
            background-position: 0% 0%;
        }
        50% {
            background-position: 100% 100%;
        }
        100% {
            background-position: 0% 0%;
        }
    }
    
    /* Fix recipe card display bugs */
    .recipe-card {
        overflow: hidden;
    }
    
    .recipe-card .card-header h5 {
        overflow: visible !important;
        text-overflow: unset !important;
        white-space: normal !important;
        max-width: 100% !important;
        flex: 1 1 auto !important;
        min-width: 0 !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
        line-height: 1.4 !important;
    }
    
    .recipe-card .card-header .d-flex {
        gap: 12px;
        align-items: flex-start !important;
    }
    
    .recipe-card .card-body {
        overflow-wrap: break-word;
        word-wrap: break-word;
    }
    
    .recipe-card ol li {
        word-wrap: break-word;
        overflow-wrap: break-word;
    }
    
    /* Fix ingredient badges overflow - allow full text display */
    .recipe-card .badge {
        max-width: 100% !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
        overflow: visible !important;
        text-overflow: unset !important;
        display: inline-block !important;
        margin-bottom: 4px;
        line-height: 1.5 !important;
    }
    
    /* Specific styles for ingredient badges */
    .recipe-card .ingredient-in-pantry,
    .recipe-card .ingredient-expiring-soon {
        max-width: 100% !important;
        white-space: normal !important;
        word-wrap: break-word !important;
        overflow-wrap: break-word !important;
        word-break: break-word !important;
        overflow: visible !important;
        text-overflow: unset !important;
        display: inline-block !important;
        padding: 6px 12px !important;
        line-height: 1.5 !important;
    }
    
    /* Mobile responsiveness for recipe cards */
    @media (max-width: 768px) {
        .recipe-card .card-header h5 {
            font-size: 1rem !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: break-word !important;
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: unset !important;
        }
        
        .recipe-card .card-header .d-flex {
            flex-direction: column;
            align-items: flex-start !important;
        }
        
        .recipe-card .badge {
            max-width: 100% !important;
            font-size: 0.75rem !important;
            white-space: normal !important;
            word-wrap: break-word !important;
            overflow-wrap: break-word !important;
            word-break: break-word !important;
            overflow: visible !important;
            text-overflow: unset !important;
            line-height: 1.5 !important;
        }
        
        .recipe-card .card-body {
            padding: 16px !important;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2 class="text-primary mb-2">
                        <i class="bi bi-book me-2"></i>AI Recipe Suggestions
                    </h2>
                    <p class="text-muted mb-0">Recipes generated based on your pantry items</p>
                </div>
                <div class="text-end">
                    <span class="badge bg-primary fs-6">{{ pantry_items|length }} items in pantry</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Pantry Items Used -->
    {% if pantry_items_full %}
    <div class="alert alert-info mb-4">
        <h6 class="mb-2"><i class="bi bi-basket-fill me-2"></i>Using these pantry items:</h6>
        <div class="d-flex flex-wrap gap-2">
            {% for item in pantry_items_full %}
                {% set item_name = item.get('name', '') if item|is_dict else item %}
                {% if item_name %}
                <span class="badge bg-light text-dark" style="word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; white-space: normal; overflow: visible; text-overflow: unset; max-width: 100%; display: inline-block; line-height: 1.5;" title="{{ item_name }}">{{ item_name }}</span>
                {% endif %}
            {% endfor %}
        </div>
    </div>
    {% elif pantry_items %}
    <div class="alert alert-info mb-4">
        <h6 class="mb-2"><i class="bi bi-basket-fill me-2"></i>Using these pantry items:</h6>
        <div class="d-flex flex-wrap gap-2">
            {% for item in pantry_items %}
            <span class="badge bg-light text-dark" style="word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; white-space: normal; overflow: visible; text-overflow: unset; max-width: 100%; display: inline-block; line-height: 1.5;" title="{{ item }}">{{ item }}</span>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {% if recipes %}
        <div class="row">
            {% for recipe in recipes %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card shadow-sm border-0 h-100 recipe-card" style="--delay: {{ loop.index0 * 0.1 }};">
                        <div class="card-header bg-gradient-primary text-white border-0" style="position: relative; overflow: visible;">
                            <div style="position: absolute; top: -50%; right: -50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 70%); opacity: 0.5;"></div>
                            <div class="d-flex justify-content-between align-items-start" style="gap: 12px; flex-wrap: wrap; align-items: flex-start !important;">
                                <h5 class="mb-0" style="overflow: visible; text-overflow: unset; white-space: normal; flex: 1 1 auto; min-width: 0; max-width: 100%; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; line-height: 1.4;" title="{{ recipe.name }}">{{ recipe.name }}</h5>
                                <div class="text-end" style="flex-shrink: 0;">
                                    {% if recipe.health_rating %}
                                        {% if recipe.health_rating == "Healthy" %}
                                        <span class="badge bg-success text-white mb-1">
                                            <i class="bi bi-heart-fill me-1"></i>{{ recipe.health_rating }}
                                        </span>
                                        {% elif recipe.health_rating == "Moderately Healthy" %}
                                        <span class="badge bg-warning text-dark mb-1">
                                            <i class="bi bi-heart me-1"></i>{{ recipe.health_rating }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-danger text-white mb-1">
                                            <i class="bi bi-exclamation-triangle me-1"></i>{{ recipe.health_rating }}
                                        </span>
                                        {% endif %}
                                    {% endif %}
                                    {% if recipe.difficulty %}
                                    <br><span class="badge bg-light text-dark">{{ recipe.difficulty }}</span>
                                    {% endif %}
                                    {% if recipe.cooking_time %}
                                    <br><small class="opacity-75"><i class="bi bi-clock me-1"></i>{{ recipe.cooking_time }}</small>
                                    {% endif %}
                                    {% if recipe.servings %}
                                    <br><small class="opacity-75"><i class="bi bi-people me-1"></i>{{ recipe.servings }}</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            {% set total_ingredients = recipe.ingredients|length %}
                            {% set in_pantry_count = 0 %}
                            {% set missing_ingredients = [] %}
                            
                            {% for ing in recipe.ingredients %}
                                {% set ing_lower = ing|lower %}
                                {% set ing_clean = ing_lower|trim %}
                                {% set is_in_pantry = False %}
                                
                                {% if pantry_items_full %}
                                    {% for item in pantry_items_full %}
                                        {% set item_name_lower = (item.get('name', '')|string|trim|lower) if item|is_dict else (item|string|trim|lower) %}
                                        {% if not is_in_pantry and item_name_lower and (item_name_lower == ing_clean or item_name_lower in ing_clean or ing_clean in item_name_lower or item_name_lower|replace(' ', '') == ing_clean|replace(' ', '') or item_name_lower|replace(' ', '') in ing_clean|replace(' ', '') or ing_clean|replace(' ', '') in item_name_lower|replace(' ', '')) %}
                                            {% set is_in_pantry = True %}
                                            {% set in_pantry_count = in_pantry_count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                {% elif pantry_items %}
                                    {% for item in pantry_items %}
                                        {% set item_lower = (item|string|trim|lower) if item else '' %}
                                        {% if not is_in_pantry and item_lower and (item_lower == ing_clean or item_lower in ing_clean or ing_clean in item_lower or item_lower|replace(' ', '') == ing_clean|replace(' ', '') or item_lower|replace(' ', '') in ing_clean|replace(' ', '') or ing_clean|replace(' ', '') in item_lower|replace(' ', '')) %}
                                            {% set is_in_pantry = True %}
                                            {% set in_pantry_count = in_pantry_count + 1 %}
                                        {% endif %}
                                    {% endfor %}
                                {% endif %}
                                
                                {% if not is_in_pantry %}
                                    {% set missing_ingredients = missing_ingredients + [ing] %}
                                {% endif %}
                            {% endfor %}
                            
                            {% if total_ingredients > 0 %}
                                {% set match_percentage = ((in_pantry_count / total_ingredients) * 100)|round|int %}
                            {% else %}
                                {% set match_percentage = 0 %}
                            {% endif %}
                            
                            {% if match_percentage >= 80 %}
                                {% set match_bg = "linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.08) 100%)" %}
                                {% set match_border = "#10B981" %}
                                {% set match_color = "#10B981" %}
                                {% set match_text_color = "#059669" %}
                                {% set match_badge_bg = "linear-gradient(135deg, #10B981 0%, #059669 100%)" %}
                            {% elif match_percentage >= 50 %}
                                {% set match_bg = "linear-gradient(135deg, rgba(245, 158, 11, 0.1) 0%, rgba(217, 119, 6, 0.08) 100%)" %}
                                {% set match_border = "#F59E0B" %}
                                {% set match_color = "#F59E0B" %}
                                {% set match_text_color = "#D97706" %}
                                {% set match_badge_bg = "linear-gradient(135deg, #F59E0B 0%, #D97706 100%)" %}
                            {% else %}
                                {% set match_bg = "linear-gradient(135deg, rgba(239, 68, 68, 0.1) 0%, rgba(220, 38, 38, 0.08) 100%)" %}
                                {% set match_border = "#EF4444" %}
                                {% set match_color = "#EF4444" %}
                                {% set match_text_color = "#DC2626" %}
                                {% set match_badge_bg = "linear-gradient(135deg, #EF4444 0%, #DC2626 100%)" %}
                            {% endif %}
                            
                            <!-- Recipe Match Score -->
                            <div class="mb-3 p-3 rounded" style="--match-bg: {{ match_bg }}; --match-border: {{ match_border }}; background: var(--match-bg); border-left: 4px solid var(--match-border);">
                                <div class="d-flex align-items-center justify-content-between">
                                    <div>
                                        <h6 class="mb-1 fw-bold" style="color: #1e293b;">
                                            <i class="bi bi-check-circle-fill me-2" style="--match-color: {{ match_color }}; color: var(--match-color);"></i>Recipe Match
                                        </h6>
                                        <p class="mb-0 small" style="color: #64748b;">
                                            <strong style="--match-text-color: {{ match_text_color }}; color: var(--match-text-color);">Uses {{ in_pantry_count }} / {{ total_ingredients }} pantry items</strong>
                                            {% if missing_ingredients|length > 0 %}
                                                <br><span class="text-muted">Missing: {{ missing_ingredients[:3]|join(', ') }}{% if missing_ingredients|length > 3 %}...{% endif %}</span>
                                            {% endif %}
                                        </p>
                                    </div>
                                    <div class="text-end">
                                        <div class="badge px-3 py-2 fw-bold" style="--match-badge-bg: {{ match_badge_bg }}; background: var(--match-badge-bg); color: white; font-size: 1rem;">
                                            {{ match_percentage }}%
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h6 class="text-primary mb-3">
                                <i class="bi bi-list-ul me-2"></i>Ingredients
                            </h6>
                            <div class="mb-4">
                                {% for ing in recipe.ingredients %}
                                    {% set ing_lower = ing|lower %}
                                    {% set pantry_item = None %}
                                    {% set is_expiring_soon = False %}
                                    {% set is_in_pantry = False %}
                                    
                                    {% if pantry_items_full %}
                                        {% for item in pantry_items_full %}
                                            {% set item_name_lower = (item.get('name', '')|string|trim|lower) if item|is_dict else (item|string|trim|lower) %}
                                            {% set ing_clean = ing_lower|trim %}
                                            {% if not is_in_pantry and item_name_lower and (item_name_lower == ing_clean or item_name_lower in ing_clean or ing_clean in item_name_lower or item_name_lower|replace(' ', '') == ing_clean|replace(' ', '') or item_name_lower|replace(' ', '') in ing_clean|replace(' ', '') or ing_clean|replace(' ', '') in item_name_lower|replace(' ', '')) %}
                                                {% set pantry_item = item %}
                                                {% set is_in_pantry = True %}
                                                {% if item|is_dict %}
                                                    {% set exp_date = item.get('expirationDate', '') %}
                                                    {% if exp_date and exp_date != 'None' and exp_date != '' and exp_date != 'null' %}
                                                        {% if exp_date|is_expiring_soon %}
                                                            {% set is_expiring_soon = True %}
                                                        {% endif %}
                                                    {% endif %}
                                                {% endif %}
                                            {% endif %}
                                        {% endfor %}
                                    {% elif pantry_items and ing in pantry_items %}
                                        {% set is_in_pantry = True %}
                                    {% endif %}
                                    
                                    {% if is_in_pantry %}
                                        {% if is_expiring_soon %}
                                        <span class="badge bg-warning text-dark me-2 mb-2 ingredient-expiring-soon" style="background: linear-gradient(135deg, #F59E0B 0%, #D97706 100%) !important; color: white !important; font-weight: 600; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; white-space: normal; overflow: visible; text-overflow: unset; max-width: 100%; display: inline-block; line-height: 1.5;">
                                            <i class="bi bi-exclamation-triangle-fill me-1"></i>{{ ing }}
                                        </span>
                                        {% else %}
                                        <span class="badge bg-success text-white me-2 mb-2 ingredient-in-pantry" style="background: linear-gradient(135deg, #10B981 0%, #059669 100%) !important; font-weight: 600; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; white-space: normal; overflow: visible; text-overflow: unset; max-width: 100%; display: inline-block; line-height: 1.5;">
                                            <i class="bi bi-check-circle me-1"></i>{{ ing }}
                                        </span>
                                        {% endif %}
                                    {% else %}
                                    <span class="badge bg-light text-dark me-2 mb-2" style="word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; white-space: normal; overflow: visible; text-overflow: unset; max-width: 100%; display: inline-block; line-height: 1.5;">{{ ing }}</span>
                                    {% endif %}
                                {% endfor %}
                                <div class="mt-2">
                                    <small class="text-muted">
                                        <i class="bi bi-info-circle me-1"></i>
                                        <span class="badge bg-success text-white me-1" style="font-size: 0.7rem; padding: 2px 6px; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; white-space: normal; overflow: visible; text-overflow: unset; max-width: 100%; display: inline-block; line-height: 1.5;">Green</span> = In pantry
                                        <span class="badge bg-warning text-dark me-1" style="font-size: 0.7rem; padding: 2px 6px; background: #F59E0B !important; color: white !important; word-wrap: break-word; overflow-wrap: break-word; word-break: break-word; white-space: normal; overflow: visible; text-overflow: unset; max-width: 100%; display: inline-block; line-height: 1.5;">Orange</span> = Expires soon (â‰¤7 days)
                                    </small>
                                </div>
                            </div>

                            <h6 class="text-primary mb-3">
                                <i class="bi bi-list-ol me-2"></i>Instructions
                            </h6>
                            <ol class="mb-4">
                                {% for step in recipe.instructions %}
                                <li class="mb-2">{{ step }}</li>
                                {% endfor %}
                            </ol>

                            <!-- Health Assessment -->
                            {% if recipe.health_rating and recipe.health_explanation %}
                            <div class="alert alert-info mb-4">
                                <div class="d-flex align-items-start">
                                    {% if recipe.health_rating == "Healthy" %}
                                    <i class="bi bi-heart-fill text-success fs-4 me-3 mt-1"></i>
                                    {% elif recipe.health_rating == "Moderately Healthy" %}
                                    <i class="bi bi-heart text-warning fs-4 me-3 mt-1"></i>
                                    {% else %}
                                    <i class="bi bi-exclamation-triangle text-danger fs-4 me-3 mt-1"></i>
                                    {% endif %}
                                    <div>
                                        <h6 class="mb-1">
                                            {% if recipe.health_rating == "Healthy" %}
                                            <span class="text-success fw-bold">{{ recipe.health_rating }}</span>
                                            {% elif recipe.health_rating == "Moderately Healthy" %}
                                            <span class="text-warning fw-bold">{{ recipe.health_rating }}</span>
                                            {% else %}
                                            <span class="text-danger fw-bold">{{ recipe.health_rating }}</span>
                                            {% endif %}
                                        </h6>
                                        <small class="text-muted">{{ recipe.health_explanation }}</small>
                                    </div>
                                </div>
                            </div>
                            {% endif %}

                            <!-- Nutrition Info -->
                            {% if recipe.nutrition %}
                            <div class="card bg-light border-0 mb-3">
                                <div class="card-header bg-gradient-success text-white border-0">
                                    <h6 class="mb-0"><i class="bi bi-bar-chart me-2"></i>Nutrition Facts</h6>
                                </div>
                                <div class="card-body">
                                    <table class="table table-sm table-bordered mb-0">
                                        <tr><th>Calories</th><td>{{ recipe.nutrition.calories }}</td></tr>
                                        <tr><th>Carbs</th><td>{{ recipe.nutrition.carbs }} g</td></tr>
                                        <tr><th>Protein</th><td>{{ recipe.nutrition.protein }} g</td></tr>
                                        <tr><th>Fat</th><td>{{ recipe.nutrition.fat }} g</td></tr>
                                        <tr><th>Fiber</th><td>{{ recipe.nutrition.fiber }} g</td></tr>
                                    </table>
                                </div>
                            </div>
                            <div class="text-center">
                                <a href="{{ url_for('recipe_detail', recipe_name=recipe.name) }}" 
                                   class="btn btn-success btn-sm">
                                    <i class="bi bi-book me-2"></i>Learn More About This Recipe
                                </a>
                            </div>
                            {% else %}
                            <div class="text-center">
                                <a href="{{ url_for('recipe_detail', recipe_name=recipe.name) }}" 
                                   class="btn btn-success btn-sm">
                                    <i class="bi bi-book me-2"></i>Learn More About This Recipe
                                </a>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="alert alert-warning text-center">
            <i class="bi bi-exclamation-circle me-2"></i> 
            No recipes could be generated with your pantry items. Try adding more ingredients!
        </div>
    {% endif %}

    <!-- Action Buttons -->
    <div class="row mt-4">
        <div class="col-12 text-center">
            <a href="{{ url_for('generate_new_recipes') }}" class="btn btn-primary me-3">
                <i class="bi bi-arrow-clockwise me-2"></i>Generate New Recipes
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-outline-secondary">
                <i class="bi bi-house me-2"></i>Back to Pantry
            </a>
        </div>
    </div>
</div>

<style>
@media print {
    /* Hide interactive elements */
    .btn, .alert, .breadcrumb {
        display: none !important;
    }
    
    /* Print-friendly layout */
    body {
        font-size: 11pt !important;
        line-height: 1.3 !important;
        color: #000 !important;
        background: white !important;
    }
    
    .container {
        max-width: none !important;
        padding: 0 !important;
        margin: 0 !important;
    }
    
    /* Recipe cards */
    .card {
        border: 2px solid #000 !important;
        box-shadow: none !important;
        margin-bottom: 20pt !important;
        page-break-inside: avoid !important;
        width: 100% !important;
    }
    
    .card-header {
        background: #f8f9fa !important;
        color: #000 !important;
        border-bottom: 2px solid #000 !important;
        padding: 10pt !important;
    }
    
    .card-header h5 {
        font-size: 14pt !important;
        margin: 0 !important;
        font-weight: bold !important;
    }
    
    .card-header .badge {
        background: #e9ecef !important;
        color: #000 !important;
        border: 1px solid #000 !important;
        font-size: 9pt !important;
        margin: 1pt !important;
    }
    
    .card-body {
        padding: 12pt !important;
    }
    
    /* Ingredients */
    .badge {
        background: #f8f9fa !important;
        color: #000 !important;
        border: 1px solid #000 !important;
        font-size: 9pt !important;
        margin: 1pt !important;
        display: inline-block !important;
    }
    
    /* Instructions */
    ol {
        margin: 8pt 0 !important;
    }
    
    li {
        margin-bottom: 4pt !important;
    }
    
    /* Health assessment */
    .alert-info {
        border: 1px solid #000 !important;
        background: #f8f9fa !important;
        margin: 8pt 0 !important;
        padding: 8pt !important;
    }
    
    /* Nutrition table */
    .table {
        font-size: 9pt !important;
        margin: 8pt 0 !important;
    }
    
    .table th, .table td {
        border: 1px solid #000 !important;
        padding: 3pt !important;
    }
    
    .table th {
        background: #f8f9fa !important;
        font-weight: bold !important;
    }
    
    /* Remove gradients and colors */
    .bg-gradient-primary, .bg-gradient-success, .bg-gradient-info, .bg-gradient-warning {
        background: #f8f9fa !important;
        color: #000 !important;
    }
    
    /* Page breaks */
    .card {
        page-break-inside: avoid !important;
    }
    
    h1, h2, h3, h4, h5, h6 {
        page-break-after: avoid !important;
    }
    
    /* Print header */
    @page {
        margin: 0.75in;
        @top-center {
            content: "SmartPantry Recipes";
        }
    }
    
    /* Two-column layout for recipes */
    .row .col-lg-4 {
        width: 48% !important;
        float: left !important;
        margin-right: 4% !important;
    }
    
    .row .col-lg-4:nth-child(even) {
        margin-right: 0 !important;
    }
}
</style>

{% endblock %}
